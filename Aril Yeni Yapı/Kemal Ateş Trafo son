DROP TABLE DWH.TMP_TRAFO_001;

CREATE TABLE DWH.TMP_TRAFO_001 NOLOGGING PARALLEL AS
SELECT 
DISTINCT C.ENERJI_TABLO_KAYIT_ID,P.PROJE_KODU,P.PROJE_BITIS_TARIHI,P.ENERJI_TABLO_KAYIT_KODU
FROM DWH_STAGE.TRAFO_PROJE P
LEFT JOIN ODS_CBS_MAESTRO_DEDAS.ADR_ABONE C ON LPAD(P.ABONE_TESISAT,8,0) = LPAD(C.TESISAT_NO,8,0);

DROP TABLE DWH.TMP_TRAFO_002;

CREATE TABLE DWH.TMP_TRAFO_002 NOLOGGING PARALLEL AS
SELECT DISTINCT T.ID,T.KODU,PR.PROJE_KODU,PR.PROJE_BITIS_TARIHI,PR.ENERJI_TABLO_KAYIT_KODU ESKI_TRAFO_KODU
FROM ODS_CBS_MAESTRO_DEDAS.SBK_TRAFOBINATIP T
INNER JOIN DWH.TMP_TRAFO_001 PR ON T.ID = PR.ENERJI_TABLO_KAYIT_ID;

DROP TABLE DWH.TMP_SUBS_CONS_001;

CREATE TABLE DWH.TMP_SUBS_CONS_001 NOLOGGING PARALLEL 32 AS
SELECT A.TESISAT_NO ABONE_TESISAT,AB.PROJE_KODU,AB.PROJE_BITIS_TARIHI,T.TAHAKKUK_AY ABONE_TUKETIM_AY,T.AYLIK_TL ABONE_TAHAKKUK_TL,T.AYLIK_KWH ABONE_TUKETIM,A.ENERJI_TABLO_KAYIT_KODU YENI_TRAFO_KODU
FROM ODS_CBS_MAESTRO_DEDAS.ADR_ABONE A 
INNER JOIN DWH.TMP_TRAFO_002 AB ON A.ENERJI_TABLO_KAYIT_ID = AB.ID
LEFT JOIN DWH.AYLIK_TAHAKKUK T ON LPAD(A.TESISAT_NO,8,0)=LPAD(T.TESISAT_NO,8,0)
WHERE T.TAHAKKUK_AY BETWEEN 201505 AND 201711
GROUP BY A.TESISAT_NO,AB.PROJE_KODU,AB.PROJE_BITIS_TARIHI,T.TAHAKKUK_AY,T.AYLIK_TL,T.AYLIK_KWH,A.ENERJI_TABLO_KAYIT_KODU;

DROP TABLE DWH.TMP_TRANS_CONS_001;

CREATE TABLE DWH.TMP_TRANS_CONS_001 NOLOGGING PARALLEL 32 AS
SELECT 
C.SUBSCRIBER_ID TRAFO_TESISAT,P.ABONE_TESISAT,T.ID TRAFO_ID,T.KODU TRAFO_KODU,P.PROJE_KODU,P.PROJE_BITIS_TARIHI,C.RECEIVED_ENERGY_VALUE TRAFO_TUKETIM,C.PROFILE_DATE TRAFO_TUKETIM_AY
FROM DWH_STAGE.TRAFO_PROJE P
INNER JOIN ODS_CBS_MAESTRO_DEDAS.ADR_ABONE A ON (LPAD(P.ABONE_TESISAT,8,0)=LPAD(A.TESISAT_NO,8,0))
INNER JOIN ODS_CBS_MAESTRO_DEDAS.SBK_TRAFOBINATIP T ON (A.ENERJI_TABLO_KAYIT_ID = T.ID)
LEFT JOIN DWH_EDW.F_MRR_CONSUMPTION_MONTHLY C ON LPAD(T.TESISAT_NO,8,0) = LPAD(C.SUBSCRIBER_ID,8,0)
WHERE C.PROFILE_DATE BETWEEN 201505 AND 201711
GROUP BY T.ID,T.KODU,P.PROJE_KODU,P.PROJE_BITIS_TARIHI,C.RECEIVED_ENERGY_VALUE,C.SUBSCRIBER_ID,C.PROFILE_DATE,P.ABONE_TESISAT;

DROP TABLE DWH.TMP_SUBS_TRANS_DETAIL1;

CREATE TABLE DWH.TMP_SUBS_TRANS_DETAIL1 NOLOGGING PARALLEL 32 AS
SELECT 
T.PROJE_KODU,T.PROJE_BITIS_TARIHI,T.TRAFO_ID,T.TRAFO_KODU,T.TRAFO_TESISAT,A.ABONE_TESISAT,T.TRAFO_TUKETIM,T.TRAFO_TUKETIM_AY,A.ABONE_TUKETIM,A.ABONE_TUKETIM_AY,ABONE_TAHAKKUK_TL
FROM DWH.TMP_TRANS_CONS_001 T 
LEFT JOIN DWH.TMP_SUBS_CONS_001 A ON T.ABONE_TESISAT=A.ABONE_TESISAT AND T.TRAFO_TUKETIM_AY = A.ABONE_TUKETIM_AY;

INSERT --+PARALLEL(128) APPEND NOLOGGING 
INTO DWH.TMP_SUBS_TRANS_DETAIL1 
SELECT 
A.PROJE_KODU,A.PROJE_BITIS_TARIHI,0,A.YENI_TRAFO_KODU, NULL TRAFO_TESISAT,A.ABONE_TESISAT,0 TRAFO_TUKETIM,0 TRAFO_TUKETIM_AY,A.ABONE_TUKETIM,A.ABONE_TUKETIM_AY,ABONE_TAHAKKUK_TL
FROM DWH.TMP_SUBS_CONS_001 A
WHERE NOT EXISTS (SELECT NULL FROM DWH.TMP_TRANS_CONS_001 T WHERE A.YENI_TRAFO_KODU = T.TRAFO_KODU) ;
--LEFT JOIN DWH.TMP_SUBS_CONS_001 A ON T.ABONE_TESISAT<>A.ABONE_TESISAT AND T.TRAFO_TUKETIM_AY IS NULL;

DROP TABLE DWH.TR_SUBS_SON;

CREATE TABLE DWH.TR_SUBS_SON NOLOGGING PARALLEL 8 AS
SELECT 
PROJE_KODU,PROJE_BITIS_TARIHI,TRAFO_ID,TRAFO_KODU,TRAFO_TESISAT,TRAFO_TUKETIM,TRAFO_TUKETIM_AY,COUNT(ABONE_TESISAT) ABONE_SAYISI,SUM(ABONE_TUKETIM) ABONE_TUKETIM,ABONE_TUKETIM_AY,SUM(ABONE_TAHAKKUK_TL) ABONE_TAHAKKUK_TL 
FROM DWH.TMP_SUBS_TRANS_DETAIL1
WHERE ABONE_TUKETIM_AY IS NOT NULL AND ABONE_TUKETIM_AY <201711
GROUP BY
PROJE_KODU,PROJE_BITIS_TARIHI,TRAFO_ID,TRAFO_KODU,TRAFO_TESISAT,TRAFO_TUKETIM,TRAFO_TUKETIM_AY,ABONE_TUKETIM_AY;

--
--SELECT * FROM DWH.TR_SUBS_SON WHERE TRAFO_KODU IS NULL
--
--
--SELECT *
--FROM DWH.TMP_SUBS_CONS_001 A
--WHERE NOT EXISTS (SELECT NULL FROM DWH.TMP_TRANS_CONS_001 WHERE A.YENI_TRAFO_KODU = TRAFO_KODU) AND ABONE_TUKETIM >0 ;


--SELECT PROJE_KODU,COUNT( DISTINCT TRAFO_KODU) FROM DWH.TR_SUBS_SON 
--GROUP BY PROJE_KODU
--
--WHERE TRAFO_KODU = '72TR-04223'

--
--
--SELECT --+PARALLEL(C,64)
--DISTINCT T.ID
--FROM DWH_STAGE.TRAFO_PROJE P
--INNER JOIN ODS_CBS_MAESTRO_DEDAS.ADR_ABONE A ON (LPAD(P.ABONE_TESISAT,8,0)=LPAD(A.TESISAT_NO,8,0))
--INNER JOIN ODS_CBS_MAESTRO_DEDAS.SBK_TRAFOBINATIP T ON (A.ENERJI_TABLO_KAYIT_ID = T.ID)
--INNER JOIN DWH_EDW.F_MRR_CONSUMPTION_MONTHLY C ON LPAD(T.TESISAT_NO,8,0) = LPAD(C.SUBSCRIBER_ID,8,0)
--WHERE C.PROFILE_DATE BETWEEN 201505 AND 201711
--GROUP BY T.ID,T.KODU,P.PROJE_KODU,P.PROJE_BITIS_TARIHI,C.RECEIVED_ENERGY_VALUE,C.SUBSCRIBER_ID,C.PROFILE_DATE,P.ABONE_TESISAT;




--WITH TOPLAM AS
--(
--SELECT 
--PROJE_KODU,PROJE_BITIS_TARIHI,TRAFO_ID,TRAFO_KODU,TRAFO_TESISAT,TRAFO_TUKETIM,TRAFO_TUKETIM_AY,COUNT(ABONE_TESISAT) ABONE_SAYISI,SUM(ABONE_TUKETIM) ABONE_TUKETIM,ABONE_TUKETIM_AY,SUM(ABONE_TAHAKKUK_TL) ABONE_TAHAKKUK_TL 
--FROM DWH.TMP_SUBS_TRANS_DETAIL
--GROUP BY 
--PROJE_KODU,PROJE_BITIS_TARIHI,TRAFO_ID,TRAFO_KODU,TRAFO_TESISAT,TRAFO_TUKETIM,TRAFO_TUKETIM_AY,ABONE_TUKETIM_AY
--)
----SELECT * FROM TOPLAM WHERE TRAFO_TESISAT = 92175822 AND ABONE_TUKETIM_AY IS NOT NULL
--SELECT SUM(TRAFO_TUKETIM),SUM(ABONE_TUKETIM) FROM TOPLAM WHERE TRAFO_TUKETIM_AY = 201608